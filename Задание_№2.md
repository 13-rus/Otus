## Установка и настройка PostgteSQL в контейнере Docker

**Цель:**

**установить PostgreSQL в Docker контейнере**

**настроить контейнер для внешнего подключения**

**Решение:**

1. ### Установил Docker на виртуальную машину под ОС Ubuntu
   Просмотр версии Docker
   yuriy_13rus@ubuntu:~$ docker -v
   Docker version 26.0.1, build d260a54

2. ### В домашнем каталоге создаем папку posgtres. Потом переношу ее в директорию /var/lib/
   Получается /var/lib/posgtres

3. ### Даем права на каталог posgtres
   sudo chmod -R 777 /var/lib/postgres/
 
4. ### Установка клиента PostgreSQL
   sudo apt install postgresql-client

5. ### Создаем docker-сеть: 
  yuriy_13rus@ubuntu:~$ sudo docker network create posgtres-net
  48bd1ae46d1f667a3e3eeca5770e232c6dcfd1b634c082c8d3e874742f04aea2

6. ### Подключаем созданную сеть к контейнеру сервера Postgres:
  sudo docker run --name pg-server --network posgtres-net -e POSTGRES_PASSWORD=postgres -d -p 5432:5432 -v /var/lib/postgres:/var/lib/postgresql/data postgres:15
  sыдает ошибку.
  Переставил docker
  curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh && rm get-docker.sh && sudo usermod -aG docker $USER && newgrp docker
  После этого запустился докер с примонтированной папкой

yuriy_13rus@ubuntu:~$ sudo docker run --name pg-server --network posgtres-net -e POSTGRES_PASSWORD=postgres -d -p 5432:5432 -v /var/lib/postgres:/var/lib/postgresql/data postgres:15
2f2c0aacd37f09ec2df5695fc844fc3bbecf7e34140593443b1b6c278dc56d58
yuriy_13rus@ubuntu:~$

7. Докер запущен
yuriy_13rus@ubuntu:~$ sudo docker ps -a
CONTAINER ID   IMAGE         COMMAND                  CREATED              STATUS              PORTS                                       NAMES
2f2c0aacd37f   postgres:15   "docker-entrypoint.s…"   About a minute ago   Up About a minute   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   pg-server
yuriy_13rus@ubuntu:~$


8. Запускаем отдельный контейнер с клиентом в общей сети с БД: 
sudo docker run -it --rm --network posgtres-net --name pg-client postgres:15 psql -h pg-server -U postgres

9. Создаем БД 
postgres=# create database otus_test;
CREATE DATABASE

Смотрим доступные бд, видим нашу созданную otus_test
postgres=# \l
                                                List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+------------+------------+------------+-----------------+-----------------------
 otus_test | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
(4 rows)

10. Создаем таблицу test и заполняем пару строк значениями
otus_test=# create table test (id int);
CREATE TABLE
otus_test=# insert into test (id) values(123);
INSERT 0 1
otus_test=# insert into test (id) values(121);
INSERT 0 1
otus_test=# insert into test (id) values(1);
INSERT 0 1
otus_test=# insert into test (id) values(14324);
INSERT 0 1
otus_test=# select * from test;
  id
-------
   123
   121
     1
 14324
(4 rows)

11. Подключаемся по хосту

yuriy_13rus@ubuntu:~$ psql -h localhost -U postgres -d postgres
Password for user postgres:
psql (14.11 (Ubuntu 14.11-0ubuntu0.22.04.1), server 15.6 (Debian 15.6-1.pgdg120+2))
WARNING: psql major version 14, server major version 15.
         Some psql features might not work.
Type "help" for help.
--
Запускаем еще одно окно терминала и там подключаемся к бд otus_test, проверяем данные таблицы test

yuriy_13rus@ubuntu:~$ psql -p 5432 -U postgres -h 172.20.0.2 -d otus_test -W
Password:
psql (14.11 (Ubuntu 14.11-0ubuntu0.22.04.1), server 15.6 (Debian 15.6-1.pgdg120+2))
WARNING: psql major version 14, server major version 15.
         Some psql features might not work.
Type "help" for help.

otus_test=# \l
                                 List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-----------+----------+----------+------------+------------+-----------------------
 otus_test | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
           |          |          |            |            | postgres=CTc/postgres
(4 rows)

otus_test=# select * from test;
  id
-------
   123
   121
     1
 14324
(4 rows)

12. Останавливаем контейнер и пробуем подключиться.Выдает ошибку, что и логично
psql: error: connection to server at "172.20.0.2", port 5432 failed: No route to host
        Is the server running on that host and accepting TCP/IP connections?

13. Удаляем контейнер
yuriy_13rus@ubuntu:~$ sudo docker rm 2f2c0aacd37f
2f2c0aacd37f
yuriy_13rus@ubuntu:~$ sudo docker ps -a
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
yuriy_13rus@ubuntu:~$

14. Создаем контейнер заново и проверяем наши данные.
После удаления структура каталогов в директории на местеyuriy_13rus@ubuntu:/var/lib$ sudo ls -la postgres/base/
[sudo] password for yuriy_13rus:
total 24
drwx------  6 lxd docker      4096 апр 19 11:28 .
drwx------ 19 lxd yuriy_13rus 4096 апр 19 12:11 ..
drwx------  2 lxd docker      4096 апр 19 11:24 1
drwx------  2 lxd docker      4096 апр 19 11:40 16387
drwx------  2 lxd docker      4096 апр 19 11:24 4
drwx------  2 lxd docker      4096 апр 19 11:25 5
yuriy_13rus@ubuntu:/var/lib$

sudo docker run --name pg-server --network posgtres-net -e POSTGRES_PASSWORD=postgres -d -p 5432:5432 -v /var/lib/postgres:/var/lib/postgresql/data postgres:15

После запуска подключились к контейнеру, все на месте.

Получается данные лежат на файловой системе операционной машины. 
При удалении докера, они остаются при следующем их монтировании.**
