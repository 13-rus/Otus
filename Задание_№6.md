### Работа с журналами

***Цель:***
**уметь работать с журналами и контрольными точками**
**уметь настраивать параметры журналов**

***Решение***
### 1. Настраиваем выполнение контрольной точки раз в 30 секунд.  
...  
...  
### 2. 10 минут c помощью утилиты pgbench даем нагрузку.  
...  
...  
### 3. Измеряем какой объем журнальных файлов был сгенерирован.  
 Смотрим, какой объем приходится в среднем на одну контрольную точку.  
...  
...  
### 4. Проверьте данные статистики: все ли ктрольные точки выполнялись точно по расписанию.
...  
...  
Почему так произошло?
...  
...  
### 5. Сравниваем tps в синхронном/асинхронном режиме утилитой pgbench.
Командами включаем и отключаем режимы:  
 ALTER SYSTEM SET synchronous_commit = on;  
 ALTER SYSTEM SET synchronous_commit = off;  
![image](https://github.com/13-rus/Otus/assets/120638894/4cc8fef3-c832-43ed-b72e-7ac27c2baccc)

Наблюдается двойной прирост tps по сравнению с синхронным режимом фиксации транзакций.  
Из-за того, что что серверу не надо ждать пока записи из WAL сохранятся на диске, прежде чем сообщить клиенту об успешном завершении операции.  
И все накладные расходы, связанные с этим процессом не оказывают влияния на результат.  


### 6. Создайте новый кластер с включенной контрольной суммой страниц.  
 Ставим еще один кластер 16 версии postgres
 ![image](https://github.com/13-rus/Otus/assets/120638894/7aad5426-49d6-49ec-9356-e3e49dcdc385)
Включаем контрольные суммы на остановленном сервере.
![image](https://github.com/13-rus/Otus/assets/120638894/f3a0eec1-5e45-486a-b412-01631d516820)
![image](https://github.com/13-rus/Otus/assets/120638894/092b2c03-58ed-4067-97b7-d14a03fe613e)

смотрим версию постгреса  
![image](https://github.com/13-rus/Otus/assets/120638894/d4cc2a41-27e7-4304-84ff-5b9a4b6a12a5)

 Создаем таблицу. Вставляем несколько значений.  
 ![image](https://github.com/13-rus/Otus/assets/120638894/adedfc77-727e-4c9a-a18c-ec301334b19b)
 ![image](https://github.com/13-rus/Otus/assets/120638894/2286b51a-3016-4638-acfe-9207af42f83b)
 Смотрис где лежит наша табличка  
![image](https://github.com/13-rus/Otus/assets/120638894/027a9139-8a82-481d-997e-af7f0c3ac148)

  Выключаем кластер.  
 ![image](https://github.com/13-rus/Otus/assets/120638894/4fd1820b-79df-4f18-8df2-9e7daad43ef9)
 
Измените пару байт в таблице командой  
 sudo dd if=/dev/zero of=/var/lib/postgresql/16/main/base/16388/16389 oflag=dsync conv=notrunc bs=1 count=8  
 ![image](https://github.com/13-rus/Otus/assets/120638894/366759f8-a533-4ecc-bcfc-8825e5facff8) 
  Включите кластер  
  ![image](https://github.com/13-rus/Otus/assets/120638894/78c21c29-1f2c-485c-a02b-6ef92f5598ba)
 Делаем выборку из таблицы и видим ошибку  
 ![image](https://github.com/13-rus/Otus/assets/120638894/939877f4-eef3-43d4-bfdc-35817418037b)
 Включаем параметр ignore_checksum_failure: set ignore_checksum_failure = on;  
  И видим данные  
  ![image](https://github.com/13-rus/Otus/assets/120638894/3f3cf335-249d-4027-9ef7-7513bb647c14)
  Данные прочитаны, так как заголовок блока с данными уцелел.  
