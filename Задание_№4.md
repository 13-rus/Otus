Домашнее задание
Работа с базами данных, пользователями и правами

Цель:
создание новой базы данных, схемы и таблицы
создание роли для чтения данных из созданной схемы созданной базы данных
создание роли для чтения и записи из созданной схемы созданной базы данных


### 1. Заходим в созданный кластер под пользователем postgres

### 2. Создаем новую базу данных testdb командой
		create database testdb;

### 3. Заходим в созданную БД под пользователем postgres
		 \c testdb


### 4. Cоздаtv новую схему testnm
		create schema testnm;
		
### 5. Cоздаtv новую таблицу t1 с одной колонкой c1 типа integer
		create table t1(c1 integer);

### 6. Вставляем строку со значением c1=1
		INSERT INTO t1 values(1);
		
### 7. Проверяем результат select - ом	
		select * from t1;
	Данные на месте.

### 8. Создаем новую роль readonly
		testdb=# create role readonly;
		CREATE ROLE


### 9. Даем новой роли право на подключение к базе данных testdb
		testdb=# grant connect on DATABASE testdb TO readonly;
		GRANT


### 10. Даем новой роли право на использование схемы testdb
		testdb=# grant usage on SCHEMA testdb to readonly;
		GRANT


### 11. Даем новой роли право на select для всех таблиц схемы testdb
		testdb=# grant SELECT on all TABLEs in SCHEMA testdb TO readonly;
		GRANT


### 12. Создаем пользователя testread с паролем test123
		testdb=# CREATE USER testread with password 'test123';
		CREATE ROLE


### 13. Даем роль readonly пользователю testread
		testdb=# grant readonly TO testread;
		GRANT ROLE

### 14. Заходим под пользователем testread в базу данных testdb
	У меня выдает ошибку
	testdb=# \c testdb testread
подключиться к серверу через сокет "/var/run/postgresql/.s.PGSQL.543           2" не удалось: ВАЖНО:  пользователь "testread" не прошёл проверку по           длинности (Peer)
Сохранено предыдущее подключение

	Вносим поправки в файл  sudo vim /etc/postgresql/15/main/pg_hba.conf

local   testdb          testread                                scram-sha-256
Добавили пользователю testread с бд testdb по паролю с методом scram-sha-256 на 15 версии.
После этого получилось зайти.
You are now connected to database "testdb" as user "testread".


### 15. Делаем select * from t1; и ничего не видим.
	Вышла ошибка, что 
	ОШИБКА:  нет доступа к таблице t1

### 16. После просмотра таблиц мы видим, что таблица t1 лежит в схеме public
а мы давали на схему testdb

### 17. вернитесь в базу данных testdb под пользователем postgres
postgres=# \c testdb
You are now connected to database "testdb" as user "postgres".

### 18. удалите таблицу t1
testdb=# drop table t1;
DROP TABLE


### 19.создайте ее заново но уже с явным указанием имени схемы testdb
		testdb=# CREATE TABLE testdb.t1(c1 integer);


### 20. вставьте строку со значением c1=1
		testdb=# INSERT INTO testnm.t1 values(1);

### 21. заходим под пользователем testread в базу данных testdb

Делаем select * from testdb.t1;
Опять ошибка - ОШИБКА:  нет доступа к таблице t1

повторно выдал 
testdb=# grant SELECT on all TABLEs in SCHEMA testdb TO readonly;
GRANT

И после этого увидел данные
testdb=# \c testdb postgres
You are now connected to database "testdb" as user "postgres".
testdb=# select * from testdb.t1;
 c1
----
  1
(1 row)

Получается после создания таблицы нужно перевыдать полномочия .т.к. они действовали на существующие объекты.

Выполняем команду create table t2(c1 integer); insert into t2 values (2);
testdb=# create table t2(c1 integer);
CREATE TABLE
testdb=# insert into t2 values (2);
INSERT 0 1
testdb=#

Получается ,что 
search_path указывает в первую очередь на схему public. 
А схема public создается в каждой базе данных по умолчанию. 
И grant на все действия в этой схеме дается роли public. 
А роль public добавляется всем новым пользователям. 
Соответсвенно каждый пользователь может по умолчанию создавать объекты в схеме public любой базы данных, 
ес-но если у него есть право на подключение к этой базе данных.


теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);
расскажите что получилось и почему

Отозвали права и доступ пропал у нас
testdb=# REVOKE CREATE on SCHEMA public FROM public;
REVOKE ALL on DATABASE testdb FROM public;
REVOKE
REVOKE
testdb=# \c testdb testread;
Password for user testread:
You are now connected to database "testdb" as user "testread".
testdb=> create table t3(c1 integer);
ОШИБКА:  нет доступа к схеме public
СТРОКА 1: create table t3(c1 integer);
                       ^
testdb=> insert into t2 values (2);
ОШИБКА:  нет доступа к таблице t2
testdb=> \dn
      List of schemas
  Name  |       Owner
--------+-------------------
 public | pg_database_owner
 testdb | postgres
(2 rows)
