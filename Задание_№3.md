## Установка и настройка PostgreSQL

**Цель:**

  Cоздавать дополнительный диск для уже существующей виртуальной машины, размечать его и делать на нем файловую систему
переносить содержимое базы данных PostgreSQL на дополнительный диск
переносить содержимое БД PostgreSQL между виртуальными машинами

**Решение:**

### 1. Ставим Ubuntu 22 версии на виртуальную машину и устанавливаем на нее PostgreSQL 15
![image](https://github.com/13-rus/Otus/assets/120638894/f639cbcc-b007-4a07-8f71-427fe3a2c312)

### 2. Проверяем кластер
sudo -u postgres pg_lsclusters
![image](https://github.com/13-rus/Otus/assets/120638894/045b88fa-2916-4095-b90f-ea50f8563e29)

### 3. Заходим под пользователем postgres в psql и создаем бд вместе с  таблицей и произвольным содержимым
![image](https://github.com/13-rus/Otus/assets/120638894/debe5912-a446-4b13-9fc6-831ee9abcf46)

### 4. Останавливаем postgres командой через sudo -u postgres pg_ctlcluster 15 main stop
![image](https://github.com/13-rus/Otus/assets/120638894/e0376b90-2b5e-40a4-a8c3-ebaa107e0210)

### 5. Создаем новый диск к ВМ размером 10GB
Ссылка у меня не открылась ,которая шла в ДЗ. Погуглил в интернете, вроде получилось добавить диск.
![image](https://github.com/13-rus/Otus/assets/120638894/2a62d425-5725-4ad0-bd0f-1ffcb835f8b7)

### 7. Добавляем новый диск к вирт. машине и запускаем. Пришлось повторно погасить postgres.
![image](https://github.com/13-rus/Otus/assets/120638894/d2de0ac0-9d03-468f-b22e-e53a9a118633)

### 8. Проиницмализируем диск
![image](https://github.com/13-rus/Otus/assets/120638894/065690a7-d522-49c1-b213-884c7ad2f833)
![image](https://github.com/13-rus/Otus/assets/120638894/c2b63603-df0b-47dd-a0a7-5afcdc383937)


### 9. Перезагрузим и проверим диск на месте, примонтирован ли он.
Все на месте.

### 10. Назначим пользователя postgres владельцем /mnt/data - chown -R postgres:postgres /mnt/data/
Предварительно создав каталог /data
![image](https://github.com/13-rus/Otus/assets/120638894/79432f24-9324-48ab-b60c-0badaeefbd3c)

### 11. Перенесем содержимое /var/lib/postgres/15 в /mnt/data
![image](https://github.com/13-rus/Otus/assets/120638894/91ce7806-3c60-42ab-ad75-e8472c6c43df)

### 12. Попытаемся запустить после данных действий кластер
 sudo -u postgres pg_ctlcluster 15 main start
Выдает ошибку ,что логично. У нас нет такого каталога .т.к. он перемещен.
![image](https://github.com/13-rus/Otus/assets/120638894/1f9ed35c-49cb-428c-8c99-7d9bd40c49ec)

### 13. Смотрим результат, да или нет
Результат отрицательный.

### 14. Находим конф. параметр в в файлах раположенных в /etc/postgresql/15/main, который нужно поменять
 и правим директорию
  ![image](https://github.com/13-rus/Otus/assets/120638894/d7bcb0c0-0cd1-4734-9a6c-364d56ff1381)
на /mnt/data/15/main
![image](https://github.com/13-rus/Otus/assets/120638894/01d2ea60-7a62-4eb2-b36b-04836206c1fd)

### 15. Попытаемся запустить кластер - sudo -u postgres pg_ctlcluster 15 main start
![image](https://github.com/13-rus/Otus/assets/120638894/2ea8e5c4-7466-4eea-ae5f-72ee53f42818)

...
### 16. Смотрим результат, да или нет
Результат положительный. Каталог такой существует, права postgres пользователю даны.
...
### 17. Заходим в БД и смотрим нашу табличку, которую создали до этого
Данные на месте
![image](https://github.com/13-rus/Otus/assets/120638894/6326405b-37ad-4dbd-b008-166d4b910937)

## Задание со *-кой
**Цель:**
не удаляя существующий инстанс ВМ сделайте новый, поставьте на его PostgreSQL, удалите файлы с данными из /var/lib/postgres, перемонтируйте внешний диск который сделали ранее от первой виртуальной машины ко второй и запустите PostgreSQL на второй машине так чтобы он работал с данными на внешнем диске, расскажите как вы это сделали и что в итоге получилось.
**Решение:**
### 1. Я установил новую ВМ ,поставил на нее постгрес той же версии 15. Далее добавил к ней диск виртуальный от предыдущей ВМ.
ВМ создана от 02 мая, диск от 27 апреля. Прикладываю скрин.
![image](https://github.com/13-rus/Otus/assets/120638894/e3eca117-e2f0-46ba-8fc6-61e708ad67ff)
![image](https://github.com/13-rus/Otus/assets/120638894/3739217b-d4c4-4c6c-949d-3b01f7762b5a)


### 2. Примонтировал его
![image](https://github.com/13-rus/Otus/assets/120638894/67258598-2c65-4a1f-b1ad-12d1c7771a1b)

### 3. Переименовал каталог у вновь установленного постргреса в каталог 15_old
![image](https://github.com/13-rus/Otus/assets/120638894/9f88fa6a-887c-4abc-bd4d-e0de2ab0fbe7)

### 4. df -h Смотрим наши диски и примонтированный каталог
![image](https://github.com/13-rus/Otus/assets/120638894/4baf0093-a261-4beb-a888-9fa9518505d2)

### 5. Поправили файл /etc/postgresql/15/main  и пробуем запускать postgres. Выдает ошибку.
![image](https://github.com/13-rus/Otus/assets/120638894/0a2265ee-9c7c-42ee-9e37-2b20dd943854)
Пробовал давать права  и много другое. Погуглив .пишут про файл replorigin_checkpoint, который сверяет
контрольные точки при логической репликации. Возможно он повредился как-то на виртуалке.
Я его попробовал переименовать и запустить.
![image](https://github.com/13-rus/Otus/assets/120638894/373a211c-2b8f-48ef-abec-7ecf27f125c6)

### 6. Все запустилось. БД zadanie_3 на месте и данные то же там.
![image](https://github.com/13-rus/Otus/assets/120638894/08a5844f-cc24-492e-bc40-43087f8a436e)





